<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Location Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    #map { height: 80vh; width: 100%; }
    body { font-family: Arial, sans-serif; padding:8px; }
    .controls { margin-bottom:8px; }
  </style>
</head>
<body>
  <h3>Location Dashboard</h3>
  <div class="controls">
    Filter token: <input id="tokenFilter" placeholder="leave empty to see all">
    <button id="clearBtn">Clear points (demo)</button>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([20.5937,78.9629], 5); // India center by default
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    let markers = {};
    const tokenInput = document.getElementById('tokenFilter');

    async function fetchAndPlot() {
      const token = tokenInput.value.trim();
      const q = token ? ('?token=' + encodeURIComponent(token)) : '';
      const res = await fetch('/api/locations' + q);
      const data = await res.json();
      // Add / update markers
      data.forEach(item => {
        const key = item.id;
        const lat = item.latitude, lon = item.longitude;
        if (markers[key]) {
          markers[key].setLatLng([lat, lon]);
        } else {
          const m = L.marker([lat, lon]).addTo(map)
            .bindPopup(`id:${item.id}<br>token:${item.token}<br>${new Date(item.timestamp).toLocaleString()}`);
          markers[key] = m;
        }
      });
    }

    // Poll every 3 seconds
    setInterval(fetchAndPlot, 3000);
    fetchAndPlot();

    document.getElementById('clearBtn').addEventListener('click', async () => {
      await fetch('/api/clear', { method: 'POST' });
      // remove markers
      Object.values(markers).forEach(m => map.removeLayer(m));
      markers = {};
    });
  </script>
</body>
</html>
